diff --git a/src/controllers/progresoController.js b/src/controllers/progresoController.js
index 015615293e9d94b88e75d5b590dfdef4c3e9cc5d..964a55fc51ab31d5449086f8ac708027643e4284 100644
--- a/src/controllers/progresoController.js
+++ b/src/controllers/progresoController.js
@@ -27,50 +27,92 @@ const updatePhaseStatus = async (progreso) => {
   }
 
   const ModeloFase = mongoose.model(progreso.faseModel || 'Fase');
   const nextFase = await ModeloFase.findOne({ orden: progreso.fase.orden + 1 });
   if (!nextFase) {
     logger.info(`ðŸŽ‰ No hay mÃ¡s fases despuÃ©s de "${progreso.fase.nombre}". Fin del plan formativo para ${progreso.residente.email}`);
     return;
   }
 
   const nextProgreso = await ProgresoResidente.findOne({
     residente: progreso.residente._id,
     fase: nextFase._id
   });
 
   if (nextProgreso && nextProgreso.estadoGeneral === 'bloqueada') {
     nextProgreso.estadoGeneral = 'en progreso';
     await nextProgreso.save();
     logger.info(`ðŸš€ Fase "${nextFase.nombre}" DESBLOQUEADA para ${progreso.residente.email}`);
   } else {
     logger.info(`â„¹ï¸ Fase "${nextFase.nombre}" ya estaba desbloqueada o no encontrada`);
   }
 };
 
 
 
+
+const formatProgresoParaResidente = (progresoDoc) => {
+  const plain = progresoDoc.toObject ? progresoDoc.toObject({ virtuals: true }) : progresoDoc;
+  const adjuntosPorIndice = (plain.adjuntos || []).reduce((acc, adj) => {
+    if (typeof adj.actividadIndex !== 'number') return acc;
+    const key = adj.actividadIndex;
+    if (!acc[key]) acc[key] = [];
+    acc[key].push({
+      _id: adj._id.toString(),
+      nombreArchivo: adj.nombreArchivo,
+      mimeType: adj.mimeType,
+      fechaSubida: adj.fechaSubida
+    });
+    return acc;
+  }, {});
+
+  return {
+    _id: plain._id.toString(),
+    fase: plain.fase,
+    faseModel: plain.faseModel,
+    estadoGeneral: plain.estadoGeneral,
+    actividades: (plain.actividades || []).map((act, index) => ({
+      nombre: act.nombre,
+      tipo: act.tipo,
+      completada: act.estado === 'validado',
+      comentariosResidente: act.comentariosResidente || '',
+      comentariosTutor: act.comentariosTutor || '',
+      fecha: act.fechaRealizacion,
+      fechaValidacion: act.fechaValidacion,
+      comentariosRechazo: act.comentariosRechazo || '',
+      fechaRechazo: act.fechaRechazo,
+      estado: act.estado,
+      porcentajeParticipacion: act.porcentajeParticipacion,
+      cirugia: act.cirugia,
+      otraCirugia: act.otraCirugia,
+      nombreCirujano: act.nombreCirujano,
+      adjuntos: adjuntosPorIndice[index] || []
+    }))
+  };
+};
+
+
 const inicializarProgresoFormativo = async (req, res, next) => {
   try {
   const user = await User.findById(req.params.id);
   if (!user || (user.rol !== 'residente' && user.rol !== 'participante')) {
     return res.status(404).json({ success: false, error: 'Residente no vÃ¡lido' });
   }
 
      if (req.body.tipo) user.tipo = req.body.tipo;
     const count = await inicializarProgresoFormativoDB(user);
     res.status(200).json({ success: true, count });
   } catch (err) {
     next(err);
   }
 };
 
 
 
 
 
 // @desc    Obtener todos los registros de progreso
 // @route   GET /api/progreso
 // @access  Private/Admin
 const getAllProgreso = async (req, res, next) => {
   try {
     // Solo administrador puede acceder a todos los progresos
@@ -123,125 +165,135 @@ const getProgresoResidente = async (req, res, next) => {
   if ((req.user.rol === 'residente' || req.user.rol === 'participante') && req.user.id !== req.params.id) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver el progreso de otro residente' });
   }
 
 
     if (
       req.user.rol === 'tutor' &&
       (req.user.hospital.toString() !== residente.hospital._id.toString() ||
         (req.user.especialidad !== 'ALL' && req.user.especialidad !== residente.especialidad))
     ) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver residentes de otro hospital' });
     }
     if (req.user.rol === 'csm' && req.user.zona !== residente.hospital.zona) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver residentes de otra zona' });
     }
 
     if (req.user.rol === 'profesor' && (!residente.sociedad || req.user.sociedad.toString() !== residente.sociedad.toString())) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver residentes de otra sociedad' });
     }
 
     const progresoPorFase = await ProgresoResidente.find({ residente: req.params.id })
       .populate('fase')
       .populate('actividades.actividad')
       .populate('actividades.cirugia');
 
+    await ProgresoResidente.populate(progresoPorFase, {
+      path: 'adjuntos',
+      select: 'nombreArchivo mimeType fechaSubida actividadIndex'
+    });
+
     // Ordenar las fases por su campo 'orden'
     progresoPorFase.sort((a, b) => a.fase.orden - b.fase.orden);
-      const resultado = progresoPorFase.map(item => {
-        return {
-          _id: item._id.toString(),
-          fase: item.fase,
-          faseModel: item.faseModel,
-          estadoGeneral: item.estadoGeneral,
-          actividades: item.actividades.map(act => ({
-            nombre: act.nombre,
-            tipo: act.tipo,
-            completada: act.estado === 'validado',
-            comentariosResidente: act.comentariosResidente || '',
-            comentariosTutor: act.comentariosTutor || '',
-            fecha: act.fechaRealizacion,
-            fechaValidacion: act.fechaValidacion,
-            comentariosRechazo: act.comentariosRechazo || '',
-            fechaRechazo: act.fechaRechazo,
-            estado: act.estado,
-            porcentajeParticipacion: act.porcentajeParticipacion,
-            cirugia: act.cirugia,
-            otraCirugia: act.otraCirugia,
-            nombreCirujano: act.nombreCirujano
-          }))
-        };
-      });
+    const resultado = progresoPorFase.map(formatProgresoParaResidente);
       
 
     res.status(200).json({
       success: true,
       count: resultado.length,
       data: resultado
     });
   } catch (err) {
     console.error("Error en getProgresoResidente:", err);
     next(err);
   }
 
 };
 
 
 const getProgresoResidentePorFase = async (req, res, next) => {
   try {
     const residente = await User.findById(req.params.id).populate('hospital');
 
     if (!residente) {
       return next(new ErrorResponse(`Residente no encontrado con id ${req.params.id}`, 404));
     }
 
   if (residente.rol !== 'residente' && residente.rol !== 'participante') {
       return next(new ErrorResponse(`El usuario con id ${req.params.id} no es un residente`, 400));
   }
 
   if ((req.user.rol === 'residente' || req.user.rol === 'participante') && req.user.id !== req.params.id) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver el progreso de otro residente' });
   }
 
     if (
       req.user.rol === 'tutor' &&
       (req.user.hospital.toString() !== residente.hospital._id.toString() ||
         (req.user.especialidad !== 'ALL' && req.user.especialidad !== residente.especialidad))
     ) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver residentes de otro hospital' });
     }
     if (req.user.rol === 'csm' && req.user.zona !== residente.hospital.zona) {
       return res.status(403).json({ success: false, error: 'No autorizado para ver residentes de otra zona' });
     }
 
     const progreso = await ProgresoResidente.find({ residente: req.params.id })
-     .populate('fase')
+      .populate('fase')
       .populate('actividades.actividad')
-      .populate('actividades.cirugia')
-      .lean();
+      .populate('actividades.cirugia');
 
-    const filtered = progreso.filter(p => p.residente);
+    await ProgresoResidente.populate(progreso, {
+      path: 'adjuntos',
+      select: 'nombreArchivo mimeType fechaSubida actividadIndex'
+    });
+
+    const resultado = progreso.map(item => {
+      const plain = item.toObject({ virtuals: true });
+      const adjuntosPorIndice = (plain.adjuntos || []).reduce((acc, adj) => {
+        if (typeof adj.actividadIndex !== 'number') return acc;
+        const key = adj.actividadIndex;
+        if (!acc[key]) acc[key] = [];
+        acc[key].push({
+          _id: adj._id.toString(),
+          nombreArchivo: adj.nombreArchivo,
+          mimeType: adj.mimeType,
+          fechaSubida: adj.fechaSubida
+        });
+        return acc;
+      }, {});
+
+      return {
+        ...plain,
+        actividades: plain.actividades.map((act, index) => ({
+          ...act,
+          adjuntos: adjuntosPorIndice[index] || []
+        }))
+      };
+    });
+
+    const filtered = resultado.filter(p => p.residente);
 
     res.status(200).json({
       success: true,
       count: filtered.length,
       data: filtered
     });
   } catch (err) {
     next(err);
   }
 };
 
 
 // @desc    Registrar nuevo progreso
 // @route   POST /api/progreso
 // @access  Private
 
 
 
 
 const registrarProgreso = async (req, res, next) => {
   try {
     // Si el usuario es residente, solo puede registrar su propio progreso
   if ((req.user.rol === 'residente' || req.user.rol === 'participante') && req.body.residente !== req.user.id) {
       return next(new ErrorResponse('No autorizado para registrar progreso de otro residente', 403));
   }
@@ -630,96 +682,101 @@ const marcarActividadCompletada = async (req, res, next) => {
       }
       if (![0, 25, 50, 75, 100].includes(porcentaje)) {
         return next(new ErrorResponse('Porcentaje de participaciÃ³n invÃ¡lido', 400));
       }
       actividadExistente.cirugia = cirugia;
       actividadExistente.otraCirugia = otraCirugia;
       actividadExistente.nombreCirujano = nombreCirujano;
       actividadExistente.porcentajeParticipacion = porcentaje;
     }
 
     actividadExistente.estado = 'completado';
     actividadExistente.completada = true;
     actividadExistente.fechaRealizacion = fechaRealizacion ? new Date(fechaRealizacion) : new Date();
     actividadExistente.comentariosResidente = comentariosResidente;
 
     // Si el residente adjunta un archivo, guardarlo como Adjunto en MongoDB
     if (req.files && req.files.adjunto) {
       const file = req.files.adjunto;
       const allowed = ['application/pdf', 'image/png', 'image/jpeg'];
       if (!allowed.includes(file.mimetype)) {
         return next(new ErrorResponse('Tipo de archivo no permitido', 400));
       }
       if (file.size > 5 * 1024 * 1024) {
         return next(new ErrorResponse('El archivo supera el lÃ­mite de 5MB', 400));
       }
+      await Adjunto.deleteMany({ progreso: id, actividadIndex: Number(index) });
       await Adjunto.create({
         progreso: id,
         usuario: req.user._id,
         actividadIndex: Number(index),
         nombreArchivo: file.name,
         mimeType: file.mimetype,
         datos: file.data,
         tipoArchivo: file.mimetype === 'application/pdf' ? 'documento' : 'imagen'
       });
     }
 
     await progreso.save();
 
     if (
       estadoPrevio === 'pendiente' &&
       actividadExistente.actividad &&
       actividadExistente.actividad.requiereValidacion
     ) {
       const responsables = [
         progreso.residente.tutor,
         progreso.residente.profesor
       ]
         .filter(Boolean)
         .map(id => id.toString());
 
       const destinatarios = [...new Set(responsables)];
 
       const mensaje = `El residente ${progreso.residente.nombre} ${progreso.residente.apellidos} ha completado la actividad "${actividadExistente.actividad.nombre}" y requiere validaciÃ³n.`;
 
       for (const usuario of destinatarios) {
         await Notificacion.create({
           usuario,
           tipo: 'validacion',
           mensaje,
           enlace: '/dashboard/validaciones',
           entidadRelacionada: {
             tipo: 'progreso',
             id: progreso._id
           }
         });
       }
     }
 
     await progreso.populate(['fase', 'actividades.actividad', 'actividades.cirugia']);
+    await progreso.populate({
+      path: 'adjuntos',
+      select: 'nombreArchivo mimeType fechaSubida actividadIndex'
+    });
 
-    res.status(200).json({ success: true, data: progreso });
+    res.status(200).json({ success: true, data: formatProgresoParaResidente(progreso) });
   } catch (err) {
     next(err);
   }
 };
 
 // GET /api/progreso/tutor/pendientes
 // @access Private/Tutor|Profesor
 const getProgresosPendientesDelHospital = async (req, res, next) => {
   try {
     if (req.user.rol !== 'tutor' && req.user.rol !== 'profesor' && req.user.rol !== 'csm') {
       return res.status(403).json({ success: false, error: 'No autorizado' });
     }
 
     const pendientes = await ProgresoResidente.find({
       estado: { $in: ['pendiente', 'validado', 'rechazado'] }
     })
     .populate({
       path: 'residente',
       select: 'nombre apellidos hospital sociedad especialidad',
       match: req.user.rol === 'profesor'
         ? { sociedad: req.user.sociedad }
         : req.user.rol === 'tutor'
         ? {
             hospital: req.user.hospital,
             ...(req.user.especialidad !== 'ALL'
